<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Språkcafé Facilitator Bot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <!--<link rel="stylesheet" href="main.css">-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        // runs websocket, waits for update and then uses the delivered data to update the app
        socket.on('message', function(data) {
            
          
            // change face based on the request from python, matching either the loading or speaking phase of the app
            if (data.type == "animate") {
              const svgElem = document.getElementById("bot-svg")
              const botMic = document.getElementById("bot-mic")
              const faceScaler = document.getElementById("bot-face-scaler")
              //speak -> animate face
              if (data.msg == "speak") {

                //get the current animation angle. Important to smoothly transition between loading and speaking
                const transform = window.getComputedStyle(document.getElementById("bot-face")).transform
                console.log(transform)
                if (transform != "none") {
                  const matrixValues = transform.match(/matrix.*\((.+)\)/)[1].split(', ');
                  let angle = Math.round(Math.atan2(parseFloat(matrixValues[1]), parseFloat(matrixValues[0])) * (180/Math.PI));              
                  document.getElementById("bot-face").style.transform = "rotate(" + angle + "deg)"
                }

                svgElem.classList.remove("loading")
                botMic.classList.remove("listening")
                faceScaler.classList.remove("hidden")
                setTimeout( function () {
                  svgElem.classList.add("speaking")
                }, 10)
                
              } else if (data.msg == "base") {
                svgElem.classList.remove("speaking")
                svgElem.classList.remove("loading")
                faceScaler.classList.remove("hidden")
                botMic.classList.remove("listening")
              } else if (data.msg == "load") {
                svgElem.classList.remove("speaking")
                faceScaler.classList.remove("hidden")
                botMic.classList.remove("listening")
                svgElem.classList.add("loading")
                write("Vänligen vänta...", false, true)
              } else if (data.msg == "listen") {
                svgElem.classList.remove("speaking")
                svgElem.classList.remove("loading")
                faceScaler.classList.add("hidden")
                botMic.classList.add("listening")

                write("Jag lyssnar. Vänta lite efter att du har talat, och tryck på 'P' för att avsluta.", false, true)
              }
            } else if (data.type= "display") {
              let result = write(data.msg, true);
            }

            function write (text, clear, fast) {
              let textbox = document.getElementById('dynamic-content');
              textbox.textContent = "";
                  let index = 0;
                  let words = text.split(/\s+/);
                  let speed = 400
                  if (fast) {
                    speed = 200
                  }
                  let timer = setInterval(function() {
                    if (index >= words.length) {
                      clearInterval(timer);
                      if (clear) {
                        document.getElementById("bot-svg").classList.remove("speaking")
                        document.getElementById("bot-svg").classList.remove("loading")
                        document.getElementById("bot-face-scaler").classList.remove("hidden")
                        document.getElementById("bot-mic").classList.remove("listening")
                      }
                      return true;
                    }
                    textbox.textContent += words[index];
                    index++;
                    if (index < words.length) {
                      // Add a space between words
                      textbox.textContent += ' ';
                    }
                  }, speed);
            }
        });
    </script>
</head>
<body>
  <main class="app">
    <div class="bot-containter">
      <svg height="350" width="500" fill="none">
        <g class="glow-group" id="bot-svg">
          <path class="antenna-path" d="M 65 40 L 95 80 L 115 50 L 145 90"></path>
          <circle class="antenna-top" cx="65" cy="40" r="15"/>

          <path class="whisker" d="M 110 175 L 80 175"></path>
          <path class="whisker" d="M 114.8 211.2 L 85.8 219"></path>
          <path class="whisker" d="M 115.2 138.8 L 85.4 131"></path>

          <path class="whisker" d="M 390 175 L 420 175"></path>
          <path class="whisker" d="M 384.8 211.2 L 414.6 219"></path>
          <path class="whisker" d="M 384.8 138.8 L 414.6 131"></path>
          
          <circle class="indicator-voice speaking" cx="250" cy="175" r="140" />
          <g class="bot-face-scaler" id="bot-face-scaler">
            <g class="bot-face" id="bot-face">
              <circle class="bot-eye" cx="200" cy="130" r="15" />
              <circle class="bot-eye" cx="300" cy="130" r="15" />
              <path class="bot-mouth" d="M 210 185 L 230 205 L 250 185 L 270 205 L 290 185"></path>
            </g>
          </g>
          <g class="bot-mic" id="bot-mic">
            <g class="bot-mic-scaler">
              <rect class="mic-ball" x="235" y="115" width="30" height="50" ry="15" rx="15"></rect>
              <path class="mic-stand"  d=" M 280 150 A 30 30 0 0 1 220 150 M 250 180 L 250 210 M 230 210 L 270 210" />
            </g>
          </g>
        </g>
      </svg>
      <div class="indicator-mic"></div>
    </div>
    <div class="text-container">
      <div class="response-box">
        <h1 id="dynamic-content">Hej hej!</h1>
      </div>
    </div>
  </main>
</body>
</html>